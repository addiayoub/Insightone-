const connection = require("../config/connection");
const path = require("path");
const fs = require("fs");
const checkFileExists = require("../utils/isFileExists");
const whereClause = [
  "AC SECUR RENDEMENT",
  "AD BALANCED FUND",
  "AD BONDS",
  "AD CASH",
  "AD COMPACT OBLIGATAIRE",
  "AD FIXED INCOME FUND",
  "AD MOROCCAN EQUITY FUND",
  "AD SECUR RENDEMENT",
  "AD SELECT BANK",
  "AD YIELD FUND",
  "AFAK CRP",
  "AFG CASH MANAGEMENT",
  "AFG DYNAMIC FUND",
  "AFG FLEXIBLE FUND",
  "AFG GOV BOND FUND",
  "AFG INCOME FUND",
  "AFG LIQUIDITY FUND",
  "AFG OPTIMAL FUND",
  "AFG SECUR RENDEMENT",
  "AFG T-BOND FUND",
  "AFRICAPITAL BONDS",
  "AFRICAPITAL CASH",
  "AFRICAPITAL EQUITY",
  "AFRICAPITAL LIQUIDITY",
  "AFRICAPITAL SECURITE",
  "AL AMAL",
  "AL BARID ISTITMAR",
  "AL BARID TRESORERIE",
  "AL IJTIMAI ADDAMANE",
  "AL IJTIMAI AVENIR",
  "AL IJTIMAI INMAA",
  "AL IJTIMAI PATRIMOINE",
  "AL IJTIMAI PROTECTION",
  "AL IJTIMAI SERENITE",
  "AL ISTITMAR CHAABI DIVERSIFIE",
  "ALIF I",
  "ALIF II",
  "ALIF III",
  "ALIFV",
  "ALPHA BANK FUND",
  "ALPHA DYNAMIC FUND",
  "ALPHA INCOME FUND",
  "ALPHA MONETAIRE",
  "ALPHA SECURE FUND",
  "ASSANAD CHAABI",
  "ATLANTA AVENIR",
  "ATLANTA OBLIGATIONS",
  "ATLANTA PERFORMANCE",
  "ATLAS AMBITION",
  "ATLAS CROISSANCE",
  "ATLAS EQUILIBRE",
  "ATLAS HARMONIE",
  "ATLAS LIQUIDITE",
  "ATLAS MONEBANK",
  "ATLAS OBLIGBANCAIRES",
  "ATLAS OPTIMISATION",
  "ATLAS PERENNITE",
  "ATLAS PERFORMANCE",
  "ATLAS PREMIUM",
  "ATLAS SELECTION",
  "ATLAS SERENITE",
  "ATLAS TRESORERIE",
  "ATTAKAFOUL",
  "ATTIJARI ACTIONS",
  "ATTIJARI AL MOUCHARAKA",
  "ATTIJARI CASH GARANTI",
  "ATTIJARI DIVERSIFIE",
  "ATTIJARI DIVIDEND FUND",
  "ATTIJARI FINANCES CORP RENDEMENT",
  "ATTIJARI FINANCES CORP VALEURS",
  "ATTIJARI FIXED INCOME DISTRIBUTION",
  "ATTIJARI LIQUIDITE",
  "ATTIJARI MIXED DISTRIBUTION",
  "ATTIJARI MONETAIRE JOUR",
  "ATTIJARI MONETAIRE PLUS",
  "ATTIJARI OBLIGATIONS",
  "ATTIJARI PATRIMOINE DIVERSIFIE",
  "ATTIJARI PATRIMOINE MULTIGESTION",
  "ATTIJARI PATRIMOINE TAUX",
  "ATTIJARI PATRIMOINE VALEURS",
  "ATTIJARI SECURITE",
  "ATTIJARI SELECTION",
  "ATTIJARI SOLIDARITE",
  "ATTIJARI TRESORERIE",
  "ATTIJARI VALEURS ESG",
  "AVENIR OBLIGATION",
  "AVENIR PREMIERE",
  "AVENIR PREVOYANCE",
  "AVENIR RENDEMENT",
  "AWALI",
  "AXA CROISSANCE",
  "AXA EPARGNE",
  "AXA MONETAIRE",
  "AXA OBLIG",
  "AXA PERFORMANCE",
  "AXA PERSPECTIVES",
  "AXA-AVENIR",
  "AZ TAWFIR",
  "BMCI CASH",
  "BMCI COSMOS",
  "BMCI EPARGNE CROISSANCE",
  "BMCI EPARGNE OBLIGATIONS",
  "BMCI INVEST",
  "BMCI MONETAIRE PLUS",
  "BMCI PREMIUM EQUITY GROWTH",
  "BMCI PREMIUM EQUITY INCOME",
  "BMCI PREMIUM LONG TERM BOND",
  "BMCI PREMIUM MEDIUM TERM BOND",
  "BMCI PREMIUM MONEY MARKET",
  "BMCI PREMIUM OPPORTUNITY I",
  "BMCI PREMIUM OPPORTUNITY II",
  "BMCI PREMIUM SHORT TERM BOND",
  "BMCI TRESO PLUS",
  "BMCI TRESORERIE",
  "BOND OPTIMUM",
  "C.I.M.R ATTADAMOUN",
  "C.I.M.R IDDIKHAR",
  "CAA RENDEMENT",
  "CAM ACTIONS",
  "CAM MONETAIRE",
  "CAM OBLIBANQUES",
  "CAM OBLIGATIONS",
  "CAM OBLIRENDEMENT",
  "CAP MONETAIRE PREMIERE",
  "CAP OBLIGATIONS",
  "CAP SECURICOURT",
  "CAP SECURIVALO",
  "CAPITAL AFRIQUE",
  "CAPITAL CAT",
  "CAPITAL COMBO",
  "CAPITAL DIVIDENDES PLUS",
  "CAPITAL EQUILIBRE",
  "CAPITAL IMTIYAZ GARANTI",
  "CAPITAL ISR",
  "CAPITAL PERFORMANCE",
  "CAPITAL RENDEMENT PLUS",
  "CAPITAL TRUST ACTIONS",
  "CAPITAL TRUST ALLOCATION",
  "CAPITAL TRUST BONDS",
  "CAPITAL TRUST CASH PLUS",
  "CAPITAL TRUST CROISSANCE",
  "CAPITAL TRUST DIVERSIFIE",
  "CAPITAL TRUST DYNAMIQUE",
  "CAPITAL TRUST EQUILIBRE",
  "CAPITAL TRUST EQUITY",
  "CAPITAL TRUST HARMONIE",
  "CAPITAL TRUST HORIZON",
  "CAPITAL TRUST INSTITUTIONS",
  "CAPITAL TRUST MONETAIRE",
  "CAPITAL TRUST OBLIG COURT TERME",
  "CAPITAL TRUST OBLIG PLUS",
  "CAPITAL TRUST OBLIG PREMIUM",
  "CAPITAL TRUST OBLIGATAIRE",
  "CAPITAL TRUST OPPORTUNITE",
  "CAPITAL TRUST PATRIMOINE",
  "CAPITAL TRUST PERFORMANCE",
  "CAPITAL TRUST RENDEMENT",
  "CAPITAL TRUST SECURIPLUS",
  "CAPITAL TRUST SERENITE",
  "CAPITAL TRUST TRESORERIE",
  "CAT ACTIONS",
  "CAT DIVERSIFIE",
  "CAT EQUILIBRE",
  "CAT EVOLUTION",
  "CAT OBLI FRONTIERES",
  "CDG BARID",
  "CDG BONDS DYNAMIQUE",
  "CDG CASH",
  "CDG CITOYENNETE",
  "CDG CROISSANCE",
  "CDG DYNAMIC COURT TERME",
  "CDG HORIZONS",
  "CDG INSTITUTIONS",
  "CDG IZDIHAR",
  "CDG MONETAIRE PLUS",
  "CDG MONEY PREMIUM",
  "CDG MULTIGESTION",
  "CDG OBLIG PLUS",
  "CDG OBLIG PREMIUM",
  "CDG OBLIG SECURITE",
  "CDG OBLIG SELECTION",
  "CDG OBLIGATIONS",
  "CDG OPTIMUM",
  "CDG PATRIMOINE",
  "CDG PERFORMANCE",
  "CDG PREVOYANCE",
  "CDG RENDEMENT",
  "CDG SERENITE",
  "CDG SMALL & MID CAP",
  "CDG SOLIDARITE",
  "CDG TAWFIR",
  "CDG TRESORERIE",
  "CDG-ACTIONS",
  "CDG-SECUR",
  "CDM CASH",
  "CDM EXPANSION",
  "CDM GENERATION",
  "CDM MONETAIRE PLUS",
  "CDM OBLIG PLUS",
  "CDM OBLIGATIONS",
  "CDM OPTIMUM",
  "CDM PROFIL DYNAMISME",
  "CDM PROFIL EQUILIBRE",
  "CDM PROFIL SERENITE",
  "CDM SECURITE PLUS",
  "CDM TRESOR PLUS",
  "CFG CASH SECURE",
  "CFG CORPORATE BONDS",
  "CFG CROISSANCE",
  "CFG DIVERSIFIÉ",
  "CFG EMERGENCE",
  "CFG INSTICASH",
  "CFG LIQUID BONDS",
  "CFG LIQUIDITE",
  "CFG OPPORTUNITÉS",
  "CFG PERFORMANCE",
  "CFG PROFIL CONSERVATEUR",
  "CFG PROFIL DYNAMIQUE",
  "CFG PROFIL EQUILIBRE",
  "CFG PROFIL OFFENSIF",
  "CFG PROFIL PRUDENT",
  "CFG RENDEMENT",
  "CFG RENTABILITE",
  "CFG SECURE BONDS",
  "CFG SECURITE",
  "CFG SOLIDARITE",
  "CFG SOVEREIGN BONDS",
  "CFG TRADER",
  "CFG TRESOCORP",
  "CFG VALEURS",
  "CIH ACTIONS",
  "CIH CASH",
  "CIH EPARGNE",
  "CIH MONETAIRE PLUS",
  "CIH OBLIGATIONS",
  "CIH PATRIMOINE",
  "CIH TRESORERIE",
  "CIMR AJIAL",
  "CIMR CASH DYNAMIQUE",
  "CIMR MONETAIRE",
  "CIMR MOUBADARA",
  "CIMR PREVOYANCE",
  "CIMR TRESO PLUS",
  "CKG ACTIONS IDIKHAR",
  "CKG ISR SELECTION",
  "CMKD FUND",
  "CMR ACTIONS",
  "CMR ASHOUM",
  "CMR BONDS",
  "CMR OBLIGATIONS",
  "CMR SANADATE",
  "CNIA ASSURE",
  "CNIA AVENIR",
  "CNIA PERFORMANCE",
  "CT SECUR RENDEMENT",
  "DAILY EQUITY FUND",
  "DAR AD DAMANE OPTIMUS",
  "DAR AD-DAMANE FUND",
  "ELAN SOLIDARITE",
  "EMERGENCE BANK",
  "EMERGENCE BOND FUND",
  "EMERGENCE CAPITAL",
  "EMERGENCE CASH",
  "EMERGENCE CROISSANCE",
  "EMERGENCE EQUILIBRE",
  "EMERGENCE EQUITY FUND",
  "EMERGENCE FUND",
  "EMERGENCE MONETAIRE",
  "EMERGENCE MONETAIRE PLUS",
  "EMERGENCE MONEY MARKET FUND",
  "EMERGENCE OBLIGATIONS",
  "EMERGENCE PERFORMANCE",
  "EMERGENCE RENDEMENT BANQUES",
  "EMERGENCE RENDEMENT PLUS",
  "EMERGENCE SERENITE",
  "FCP AFRICAPITAL CASH PLUS",
  "FCP AFRICAPITAL DIVERSIFIE",
  "FCP AL BADIL CHAABI ASHOUM",
  "FCP AL IDDIKHAR CHAABI ACTIONS",
  "FCP AL IDDIKHAR CHAABI KASSIR AL MADA",
  "FCP AL IDDIKHAR CHAABI MOUTAWASSIT AL MADA",
  "FCP AL IDDIKHAR CHAABI TAWIL AL MADA",
  "FCP AL IJTIMAÏ SECURITE",
  "FCP AL IJTIMAI SOLIDARITE",
  "FCP AL IKRAM",
  "FCP AL KHEIR",
  "FCP ALIF IV",
  "FCP ALIF VI",
  "FCP ALISTITMAR CHAABI ACTIONS",
  "FCP ALISTITMAR CHAABI TRESORERIE",
  "FCP ALLOCATIONS",
  "FCP ALPHA BONDS",
  "FCP ALPHA GLOBAL",
  "FCP ALPHA INVEST",
  "FCP ALPHA MONETAIRE PROTECTION",
  "FCP ALPHA OBLIGATAIRE",
  "FCP ALPHA PERFORMANCE FUND",
  "FCP ALPHA RENDEMENT",
  "FCP AMAN-FM",
  "FCP ATTIJARI GOLD",
  "FCP AVENIR ACTIONS",
  "FCP AVENIR LONG TERME",
  "FCP AXA HORIZON",
  "FCP BMCI GESTION SOLIDARITE",
  "FCP BMCI ISR",
  "FCP CAM DYNAMIQUE",
  "FCP CAM EPARGNE",
  "FCP CAM INVESTISSEMENT",
  "FCP CAM LIQUIDITE",
  "FCP CAM TRESO PLUS",
  "FCP CAP INSTITUTIONS",
  "FCP CAPITAL ACTIONS",
  "FCP CAPITAL ACTIONS PREMIUM",
  "FCP CAPITAL BALANCE",
  "FCP CAPITAL DIVERSIFIES",
  "FCP CAPITAL DYNAMIQUE",
  "FCP CAPITAL GLOBAL MACRO",
  "FCP CAPITAL IMMOBILIER",
  "FCP CAPITAL IMTIYAZ CROISSANCE",
  "FCP CAPITAL IMTIYAZ LIQUIDITE",
  "FCP CAPITAL IMTIYAZ SECURITE",
  "FCP CAPITAL IMTIYAZ TRESORERIE",
  "FCP CAPITAL INDICE",
  "FCP CAPITAL INSTITUTIONS",
  "FCP CAPITAL LONG/SHORT",
  "FCP CAPITAL MAGHREB",
  "FCP CAPITAL MONETAIRE",
  "FCP CAPITAL MONETAIRE PLUS",
  "FCP CAPITAL MULTI-GESTION",
  "FCP CAPITAL OBLIGATIONS",
  "FCP CAPITAL OBLIGATIONS BANQUES",
  "FCP CAPITAL OBLIGATIONS BANQUES PLUS",
  "FCP CAPITAL OBLIGATIONS PLUS",
  "FCP CAPITAL OPPORTUNITE",
  "FCP CAPITAL OPTIMISATION",
  "FCP CAPITAL OPTIMUM",
  "FCP CAPITAL PARTICIPATIONS",
  "FCP CAPITAL PLUS",
  "FCP CAPITAL PROTECTION",
  "FCP CAPITAL RENDEMENT",
  "FCP CAPITAL SECURITE",
  "FCP CAPITAL SELECTION",
  "FCP CAPITAL SERENITE",
  "FCP CAPITAL TAALIM",
  "FCP CAPITAL TERME",
  "FCP CAPITAL TRESOR",
  "FCP CASACTIONS",
  "FCP CAT VALEURS",
  "FCP CDM LIQUIDITES",
  "FCP CFG CONSTRUCTION",
  "FCP CFG PREVOYANCE",
  "FCP CHAABI SOLIDARITE",
  "FCP CIMR MONETAIRE PLUS",
  "FCP CIMR PATRIMOINE",
  "FCP CIMR TANMYA",
  "FCP CIMR THARWA",
  "FCP CKG BONDS",
  "FCP CKG GARANTI",
  "FCP CMR EQUITIES",
  "FCP EDUCATION",
  "FCP EMERGENCE ACTIONS",
  "FCP EMERGENCE ALLOCATION",
  "FCP EMERGENCE BALANCED FUND",
  "FCP EMERGENCE DIVERSIFIE",
  "FCP EMERGENCE OBLIG COURT TERME",
  "FCP EMERGENCE OBLIHORIZON",
  "FCP EMERGENCE OBLIRENDEMENT",
  "FCP EMERGENCE PATRIMOINE",
  "FCP EMERGENCE PERSPECTIVES",
  "FCP EMERGENCE SELECTION",
  "FCP EMERGENCE TRESOR",
  "FCP EMERGENCE TRESOR PLUS",
  "FCP EMERGENCE TRESORERIE",
  "FCP EV CAT",
  "FCP HORIZON AVENIR",
  "FCP HORIZON EQUITY VALUE",
  "FCP HORIZON FLEXIBLE",
  "FCP HORIZON PREMIUM",
  "FCP INTIMAE-FM",
  "FCP IRGAM ACTIONS",
  "FCP IRGAM MONETAIRE",
  "FCP IRGAM OBLIGATAIRE",
  "FCP KENZ ACTIONS",
  "FCP KENZ OBLIGATIONS",
  "FCP KENZ PLUS",
  "FCP KENZ RENDEMENT",
  "FCP LIQUIDITES",
  "FCP MAROC CREANCES",
  "FCP MAROC INSTITUTIONS",
  "FCP MAROC RENDEMENT",
  "FCP MAROGEST CASH",
  "FCP MEDERSAT.COM",
  "FCP MONETAIRE DYNAMIQUE",
  "FCP MONETAIRE PREMIUM",
  "FCP MOUSTAQBAL CRP",
  "FCP OBLIG CT",
  "FCP OBLIG LONG TERM",
  "FCP OBLIG OPPORTUNITES",
  "FCP OBLIG PERENITE",
  "FCP OBLIGATIONS DYNAMIQUE",
  "FCP OBLIGATIONS OPTIMUM",
  "FCP OCT DYNAMIQUE",
  "FCP OPPORTUNITES",
  "FCP PELICAN",
  "FCP RM SECUR RENDEMENT",
  "FCP RMA DIVERSIFIE",
  "FCP RMA TRESO PLUS",
  "FCP SANAD ACTIONS",
  "FCP SANLAM OBLIGATIONS",
  "FCP SECURITE",
  "FCP SECURITE DEVELOPPEMENT",
  "FCP SECURITE RENDEMENT",
  "FCP SERENITE CT",
  "FCP TRESORERIE PLUS",
  "FCP UPLINE CAPITAL GARANTI",
  "FCP UPLINE HORIZON",
  "FCP UPLINE OBLIG PLUS",
  "FCP UPLINE OPPORTUNITES",
  "FCP UPLINE RENDEMENT PLUS",
  "FH2 ACTIONS",
  "FH2 ACTIONS II",
  "FH2 OBLIGATAIRE DYNAMIQUE",
  "FORCE MUTUELLE",
  "FRUCTI VALEURS",
  "FSEC I CT",
  "FSEC II OMLT",
  "GROUPE MCMA-MAMDA OPTIMISATION",
  "HORIZON DISTRIPERF",
  "HORIZON EXPANSION",
  "HORIZON MID & SMALL CAP",
  "HORIZON OBLIG TRESOR",
  "HORIZON TREASURY FUND",
  "INSTIMONETAIRE",
  "INSTIOBLIGATIONS",
  "INSTIOBLIGATIONS ETAT",
  "INTEGRA CASH",
  "INVEST EQUILIBRE",
  "IRAD",
  "IRG SECUR RENDEMENT",
  "IRGAM ALLOCATION",
  "IRGAM BALANCE",
  "IRGAM DISTRIEQUILIBRE",
  "IRGAM DISTRIEQUITY",
  "IRGAM MONETAIRE PLUS",
  "IRGAM OBLIBANQUES",
  "IRGAM OBLIRENDEMENT",
  "IRGAM SECURIBANK",
  "IRGAM SECURIFINANCE",
  "IRGAM SECURIPLUS",
  "IRGAM STRATEGIE",
  "LEGACY ACCUMULATION FUND",
  "LIBERIS SERENITE",
  "LMV EQUITY INVEST",
  "MAROC OPPORTUNITE",
  "MAROC VALEURS",
  "MBS RENDEMENT",
  "MSIN ACTIONS",
  "MUTUELLE PREVOYANCE PLUS - MPBP",
  "OBLIDYNAMIC",
  "OBLIG INSTITUTIONS",
  "OBLIGATAIRE PLUS",
  "OBLIGATAIRE PREMIUM",
  "OBLITOP",
  "PALMARES FINANCIERES",
  "PATRIMOINE ACTIONS",
  "PATRIMOINE AL MOUSSAHAMA",
  "PATRIMOINE AVENIR",
  "PATRIMOINE CROISSANCE",
  "PATRIMOINE MULTIVALEURS",
  "PATRIMOINE OBLIGATIONS",
  "PRESCOLAIRE",
  "PROFIL DYNAMIQUE",
  "PROFIL FLEXIBLE",
  "PROFIL HARMONIE",
  "PROFIL SERENITE",
  "RMA CORPORATE BOND",
  "RMA DYNAMIQUE",
  "RMA EQUITY MARKET",
  "RMA EXPANSION",
  "RMA MULTISTRATEGIES",
  "RMA OBLIGATIONS",
  "RMA PERFORMANCE",
  "RMA RENDEMENT CT",
  "RMA RENDEMENT MT",
  "RMA RENDEMENT PLUS",
  "R-MIXT COUVERTURE",
  "R-MIXT CROISSANCE",
  "R-MIXT OPTIMUM",
  "R-MIXT PERFORMANCE",
  "R-MIXT SELECTION",
  "SAFAE",
  "SANAD OBLIGATAIRE",
  "SANAD PERFORMANCE",
  "SANAD SERENITY",
  "SCR RENDEMENT",
  "SECURITE TRESO PLUS",
  "SECURITIES PERFORMANCE",
  "SG ACTIONS PLUS",
  "SG CASH GARANTI",
  "SG CASH PLUS",
  "SG COURT TERME OBLIG",
  "SG EPARGNE PLUS ACTIONS",
  "SG EXPANSION",
  "SG NOVA",
  "SG OBLIG PLUS",
  "SG OPTIMAL OBLIG",
  "SG PERSPECTIVES",
  "SG SOCIAL IMPACT FUND",
  "SG TRESOR PLUS",
  "SG VALEURS",
  "SICAV MAROC CROISSANCE",
  "SICAVENIR",
  "SMART FUND",
  "SOCIETE CENTRALE DE REASSURANCE OBLIGATIONS",
  "SOCIETE CENTRALE DE REASSURANCE-INTEGRALE",
  "STAFF ACTION",
  "TWIN BOND",
  "TWIN BOND TRESOR",
  "TWIN CASH",
  "TWIN OPPORTUNITY",
  "TWIN TREASURY",
  "UNIVERS DIVERSIFIE",
  "UNIVERS OBLIGATIONS",
  "UPLINE ACTIONS",
  "UPLINE AVENIR",
  "UPLINE CASH",
  "UPLINE CROISSANCE",
  "UPLINE DIVERSIFIE",
  "UPLINE HORIZON DYNAMIQUE",
  "UPLINE OBLIG",
  "UPLINE OBLIG DYNAMIQUE",
  "UPLINE PATRIMOINE",
  "UPLINE PERENNITE",
  "UPLINE PROTECTION DYNAMIQUE",
  "UPLINE RENDEMENT",
  "UPLINE RETAIL SERENITE",
  "UPLINE RETAIL SERENITE PLUS",
  "UPLINE SECURE PLUS",
  "UPLINE SOLIDARITE",
  "UPLINE TRESORERIE",
  "UPLINE VALEURS PLUS",
  "WAFA ASSURANCE EXPANSION",
  "WAFA ASSURANCE OPTIMISATION",
  "WAFA ASSURANCE SECURITE",
  "WAFA ASSURANCE STRATEGIE",
  "WG ACTIONS",
  "WG BALANCED",
  "WG BOND FUND",
  "WG CAPITAL",
  "WG CROISSANCE",
  "WG DIVERSIFIE",
  "WG DYNAMIC",
  "WG EPARGNE",
  "WG EQUITY FUND",
  "WG FRUCTI PATRIMOINE",
  "WG HORIZON",
  "WG LOW VOLATILITY FACTOR FUND",
  "WG MOMENTUM FACTOR FUND",
  "WG MONETAIRE",
  "WG OBLIGATIONS",
  "WG OPPORTUNITES",
  "WG PERFORMANCE",
  "WG RENDEMENT",
  "WG SERENITE",
  "WG TAYSSIR",
  "WG VALEURS",
  "WG VALUE FACTOR FUND",
  "WINEO ACTIONS",
  "WINEO AL AMINE",
  "WINEO AMANA",
  "WINEO CASH",
  "WINEO DELTA",
  "WINEO EQUINOXE",
  "WINEO OBLIG",
  "WINEO OBLIG CT",
  "WINEO OBLIG SECURITE",
  "WINEO SECUR RENDEMENT",
];
class _CompoOpcvmController {
  async index(req, res) {
    try {
      const pool = await connection();
      const { opcvm } = req.query;
      // declare @opc as varchar(MAX)
      // set @opc="${opcvm}"

      const query = `
SELECT date, Gestionnaire, OPCVM, comp.Classification
                , FAMILLE
                , CLASSE
                , CATEGORIE
                , EMETTEUR
                , SECTEUR_BVC
                , SECTEUR_GICS
                , DEVISE
                , GARANTIE
                , tit.code
                , tit.LIBELLE
                , Quantité
                , cours
                , Valorisation
                ,
    CASE
        WHEN DATEDIFF(D, date, ECHEANCE) <= 30 THEN 'NOMINAL 1 MOIS'
        WHEN DATEDIFF(D, date, ECHEANCE) <= 90 THEN 'NOMINAL 3 MOIS'
        WHEN DATEDIFF(D, date, ECHEANCE) <= 180 THEN 'NOMINAL 6 MOIS'
        WHEN DATEDIFF(D, date, ECHEANCE) <= 365 THEN 'NOMINAL 1 AN'
        WHEN DATEDIFF(D, date, ECHEANCE) <= 730 THEN 'NOMINAL 2 ANS'
        WHEN DATEDIFF(D, date, ECHEANCE) <= 1095 THEN 'NOMINAL 3 ANS'
        WHEN DATEDIFF(D, date, ECHEANCE) <= 1825 THEN 'NOMINAL 5 ANS'
        WHEN DATEDIFF(D, date, ECHEANCE) <= 3650 THEN 'NOMINAL 10 ANS'
        WHEN DATEDIFF(D, date, ECHEANCE) <= 5475 THEN 'NOMINAL 15 ANS'
        WHEN DATEDIFF(D, date, ECHEANCE) <= 7300 THEN 'NOMINAL 20 ANS'
        WHEN DATEDIFF(D, date, ECHEANCE) <= 9125 THEN 'NOMINAL 25 ANS'
        WHEN DATEDIFF(D, date, ECHEANCE) <= 10950 THEN 'NOMINAL 25 ANS'
        ELSE IIF(categorie='LIQUIDITES','TMP',iif(categorie='PRIVATE EQUITY','MASI',iif(famille='OPCVM',op.DENOMINATION_OPCVM,bvc.LIBELLE)))
    END AS SIMULE
                , (valorisation/comp.[Valorisation globale]) * 100 as Poids
  FROM [Staging_DB].[SCRAP].[HISTO_OPC_COMPOSIT] comp
  inner join DataWarehouse.DIM.REF_TITRE tit
  on comp.code=tit.CODE
  left join DataWarehouse.DIM.TITRE_BVC bvc
  on bvc.CODE_ISIN=comp.Code and date between bvc.DATE_EFFECTIVE and bvc.DATE_EXPIRATION

  left join DataWarehouse.DIM.OPCVM op
  on op.Code_OPCVM=right(comp.Code,5) and date between op.DATE_EFFECTIVE and op.DATE_EXPIRATION
    where opcvm like '%'+@opc+'%'
  and Date=(select max(date)  FROM [Staging_DB].[SCRAP].[HISTO_OPC_COMPOSIT] where opcvm like '%'+@opc+'%')
  order by poids DESC
`;
      const request = pool.request();
      const result = await request.input("opc", opcvm).query(query);
      return res.json({ data: result.recordset });
    } catch (error) {
      res.status(500).json({ error: error.message });
    }
  }

  async getNoteInformation(req, res) {
    try {
      const pool = await connection();
      const { opcvm } = req.query;
      const query = `SELECT [DENOMINATION_OPCVM],[Code_Ptf] FROM [DataWarehouse].[DIM].[OPCVM] where DENOMINATION_OPCVM = (@opc)`;
      const request = pool.request();
      const result = await request.input("opc", opcvm).query(query);
      const resp = result.recordset[0];
      const isExists = checkFileExists("files", `${resp?.Code_Ptf}.pdf`);
      return res.json({ Code_Ptf: resp?.Code_Ptf, isExists });
    } catch (error) {
      res.status(500).json({ error: error.message });
    }
  }
}
const CompositionOpcvmController = new _CompoOpcvmController();
module.exports = CompositionOpcvmController;
